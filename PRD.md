# 软件功能开发文档 (FDD)

**定位：** 跨平台（Win/Mac）的上下文感知程序
**核心逻辑：** 识别内容 -> 过滤环境 -> 意图匹配 -> 执行动作

---

## 1. 系统架构与技术栈

### 1.1 核心选型

* **开发框架：** **Tauri 2.0 (Rust)**。
理由： Rust 保证内存安全与极致性能；Tauri 提供跨平台 Webview UI，体积小且支持原生系统调用。
* **前端 UI：** React + Tailwind CSS + Lucide Icons。
* **本地数据库：** SQLite

### 1.2 模块化设计

1. **Scanner 层 (Rust)：** 负责全局监听（鼠标/键盘钩子）。
2. **Extractor 层 (Rust)：** 执行文本抓取策略。
3. **Router 层 (Rust/JS)：** 运行 Regex 引擎与 AI 意图识别，分发任务。
4. **UI 层 (Webview)：** 渲染悬浮气泡（Ghost Icon）与智能菜单（Smart Menu）。

---

## 2. 核心模块详解

### 2.1 文本抓取引擎 (Multi-Layer Extractor)

为了提高文本抓取的成功率，Extractor 必须按序执行以下逻辑：

| 级别 | 技术实现 | 目标与场景 |
| --- | --- | --- |
| **L1 (UIA)** | 调用 Win UI Automation / Mac Accessibility API | 标准软件（浏览器、Office、Notion 等），不经过剪贴板。 |
| **L2 (Driver)** | 驱动级模拟物理按键 `Ctrl+C` | 绕过安全软件（如 360）对用户层模拟按键的拦截。 |
| **L3 (Monitor)** | 剪贴板序列号轮询 (Polling) | 处理响应慢的 PDF 或网页，检测剪贴板是否更新。 |
| **L4 (OCR)** | 静默区域截图 + 文字识别（为减小软件体积，这里调用云端API。用户可以自行选择关闭OCR功能或指定其他可用的OCR服务） | **最终兜底**。解决禁止复制的网页、图片或加密文档。 |

### 2.2 规则引擎与冲突决策 (Router)

当抓取到文本  后，Router 执行以下逻辑：

1. **清洗：** 去除首尾空白符，检测字符集编码。
2. **应用感知 (Context Filter)：** 获取当前活动进程 ID (PID)。
3. **正则匹配：** 遍历 JSON 动作库。
4. **分发：**
* 若命中N=1  且设为 `auto_execute`：直接执行。
* 若命中N>1：呼出 Smart Menu。
* 若命中N=0：调用 **AI 语义模块** 进行意图识别。

## 3. 功能需求清单

### 3.1 基础动作库 (Built-in Actions)

* **URL/DOI：** 直接调用默认浏览器打开。
* **数学运算：** 识别公式，支持浮点数及常用函数，菜单内直接显示结果。
* **系统路径：** 识别 Win/Mac 路径并一键定位文件。
* **快递查询：** 全球主流快递公司单号自动识别与跳转。
* **开发者工具：** JSON 格式化、Base64 解码、时间戳转换、颜色预览。

### 3.2 交互形态 (UI/UX)

* **Ghost Icon (灵动气泡)：** 选中文本并在鼠标移动特定位移后，在光标旁显示 40% 透明度图标。
* **Smart Menu (毛玻璃菜单)：**
* **结果预览：** 菜单第一项即动作结果（例如：翻译的内容）。
* **非激活窗口：** 弹出时点击不抢占原软件焦点。


* **Spotlight (指令框)：** 双击 `Ctrl` 唤起，支持模糊搜索动作名及直接输入参数。

### 3.3 AI 增强功能

* **语义识别：** 识别“非结构化文本”意图（如：把这段文字整理成会议要点）。
* **跨语言翻译：** 自动检测语种，提供润色后的翻译结果。
* **黑名单保护：** 设置敏感 App 列表，强制不发送内容至云端 AI。

---

## 4. 插件与同步协议

### 4.1 动作 JSON 规范

```json
{
  "meta": { "id": "uuid", "name": "BiliSearch", "version": "1.1.0" },
  "scope": { "include": ["chrome.exe"], "priority": 80 },
  "trigger": { "type": "regex", "pattern": "BV[a-zA-Z0-9]{10}" },
  "action": { "type": "url", "template": "https://bilibili.com/${0}" }
}

支持用户通过自然语言描述需求后更新：比如用户说：在谷歌浏览器中选中文字就bing搜索，那么就能自动生成对应的动作json
```

### 4.2 配置文件逻辑

* **配置文件：** 本地 `actions.json` 与 `settings.json`。
* **热更新：** 监听配置文件夹变动，修改 JSON 立即生效，无需重启。

---

## 5. 非功能性需求
* **响应速度：** 抓取到匹配的整体延迟需控制在 **150ms** 以内。
* **低耗资源：** 静态待机内存占用不超过 **50MB**，CPU 占用率在监听状态下趋近于 **0%**。